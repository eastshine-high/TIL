# 하위표현식(Subexpression)

하위 표현식은 큰 표현식 안에 속한 일부 표현식을 한 항목으로 다루도록 한데 묶은 것이다. 하위 표현식은 괄호`(Subexpression)` 사이에 사용한다.

## 하위 표현식은 언제 사용할까

아래 문장에서 HTML에서 반복해 나오는 강제 공백(`&nbsp;`)을 모두 찾아야 한다고 가정해 보자.

```
By default any subpattern matches as many times as possible.
This behaviour is changed to matching the minimum number 
if&nbsp;&nbsp;quantifier is followed with the question mark.
```

반복 찾기를 통해 다음과 같이 정규 표현식을 작성했다. `&nbsp;{2,}` 

하지만 일치하지 않았다. 왜일까? {2,}는 바로 앞에 있는 문자가 연속해서 반복된 횟수만을 표현한다. 이 경우 앞에 놓인 문자가 세미클론이므로, `&nbsp;;;;;`는 일치할 테지만 `&nbsp;&nbsp;`는 일치하지 않는다.

**하위 표현식**을 이용해 반복된 강제 공백을 찾아보자. `(&nbsp;){2,}`

```
By default any subpattern matches as many times as possible.
This behaviour is changed to matching the minimum number 
if**&nbsp;&nbsp;**quantifier is followed with the question mark.
```

`(&nbsp;)`는 하위 표현식이며 한 항목으로 취급한다. 따라서 `{2,}`는 세미콜론이 아니라 이 하위 표현식 전체가 반복하는 횟수를 나타낸다. 이제 제대로 동작한다.

## OR operator

이 예제에서는 패턴을 써 네 자리 숫자로 이루어진 연도를 일치시켜야 한다. 더 정밀한 결과를 얻고자 앞 두자리 숫자는 명확하게 19와 20으로 정했다.

```
DOB : 1967-08-17
```

> `19|20\d{2}`
> 

 `|`는 OR 연산자를 의미한다. 그런데 분명 의도한 대로 일치하지 않았다. 왜일까? OR(`|`) 연산자는 자신의 왼편과 오른편에 각각 무엇이 있는지 살펴보는데, 19|20\d{2}, 즉 \d{2} 역시 20으로 시작하는 표현의 일부로 여겼기 때문이다. 그래서 **19와 일치하든지 20으로 시작하는 네 자리 연도와 일치**할 텐데, 여기서는 19와 일치했다.

해결법은 19|20을 하위 표현식으로 묶는 것이다.

> `(19|20)\d{2}`
> 

## 중첩된 하위 표현식

정규 표현식으로 IP 주소를 찾아보자.

```
ping naver.com
PING naver.com (223.13.200.107): 56 data bytes
```

> `(\d{1,3}\.){3}\d{1,3}`
> 

이 패턴은 뭐가 잘못되었을까? 문법은 잘못되지 않았다. 문제는 유효하지 않은 IP 주소까지도 찾아낸다는 점이다.

IP 주소는 4바이트로 구성되고, 223.13.200.107으로 나타나는 IP 주소는 바로 이 4바이트 표현한 것이다. 따라서 IP 주소에서 숫자 네 묶음은 각각 한 바이트 값을 나타내고, 이 값의 범위는 0부터 255 사이의 속한다. 이는 IP 주소에 255보다 큰 숫자는 들어갈 수 없을을 의미한다. 하지만 앞서 본 패턴을 사용하면 345, 700, 999 같이 IP 주소로 바르지 않은 숫자와도 일치한다.

유효한 값의 범위를 지정할 수 있으면 매우 좋겠지만, **정규 표현식은 문자를 일치시킬 뿐이지 문자가 의미하는 바에 대해서는 아무런 지식이 없다. 또 수학적 연산을 사용할 수도 없다.** 우리가 할 수 있는 일이 있을까? 아마 있을 것이다. **정규 표현식을 만들려면 일치해야 할 것과 일치 해서는 안 되는 것을 명확하게 정의해야 한다.**

다음은 IP 주소를 구성하는 각 숫자 묶음을 유효한 조합으로 정의하는 규칙이다.

- 모든 한 자리 혹은 두 자리 숫자
- 1로 시작하는 모든 세 자리 숫자
- 2로 시작하면서 두 번째 자리 숫자가 0부터 4사이인 모든 세 자리 숫자
- 25로 시작하면서 세 번째 자리 숫자가 0부터 5사이인 모든 세 자리 숫자

> `(((25[0-5])|(2[0-4]\d)|(1\d{2})|(\d{1,2}))\.){3}(((25[0-5])|(2[0-4]\d)|(1\d{2}|(\d{1,2})))`
> 

이런 정규 표현식을 이해하려면 하위 표현식을 분해한 후 하나씩 분석하고 이해해야 한다. 처음부터 무턱대고 문자를 하나하나 이해하려고 하기보다는 작은 하위 표현식에서 사작해 점점 더 큰 덩어리로 이해하는 편이 낫다. 그러면 보기보다 훨씬 덜 복잡하다.

## 참조

<벤 포터, 손에 잡히는 10분 정규식, 인사이트>
